#
# yo!log    [Custom nginx configuration]
#


# Run worker processes as non-root user.
user appuser;

# Automatically scale worker processes based on CPU cores.
worker_processes auto;

# PID file in /tmp (writeable for non-root user).
pid /tmp/nginx/nginx.pid;

# Send error logs (info level and higher) to stderr.
error_log   /dev/stderr info;

# Load additional configurations
include /etc/nginx/modules-enabled/*.conf;

# Maximum number of open files per worker process
# See: worker_connections
worker_rlimit_nofile 1024;

events {
    # Maximum number of TCP sessions per worker
    # See: worker_rlimit_nofile
    worker_connections 1024;
}

http {
    #
    # Basic Settings
    #

    # Use xero-copy sendfile() system call for serving static files.
    sendfile on;

    # Prevent one fast connection from entirely occupying the worker process.
    # Limit amount of data transferred in single sendfile() call.
    sendfile_max_chunk 1m;

    # Accumulate HTTP response headers and initial chunk of file data into
    # a single, optimally sized TCP packet before sending it over the network.
    # Prevents packet fragmentation and improves network utilization.
    # Works only when sendfile is enabled.
    tcp_nopush on;

    # Limit size of internal hash buckets.
    types_hash_max_size 2048;

    # Don't emit build name with nginx version.
    server_tokens off;

    # server_names_hash_bucket_size 64;
    # server_name_in_redirect off;

    #
    # MIME types
    #
    include         /etc/nginx/mime.types;
    default_type    application/octet-stream;

    #
    # Temporary directories
    #
    client_body_temp_path   /tmp/nginx/client_body_temp;
    proxy_temp_path         /tmp/nginx/proxy_temp;
    fastcgi_temp_path       /tmp/nginx/fastcgi_temp;
    uwsgi_temp_path         /tmp/nginx/uwsgi;
    scgi_temp_path          /tmp/nginx/scgi_temp;

    #
    # Cache
    # Keep upto 256 files in cache. But, invalidate if not accessed after 30s.
    # Check cache validity of files after 120 seconds.
    # (Not too many static files in this application)
    #
    open_file_cache         max=256 inactive=30s;
    open_file_cache_valid   120s;


    #
    # SSL
    #

    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_prefer_server_ciphers on;

    #
    # Log
    #
    access_log /dev/stdout;

    #
    # Gzip
    #

    gzip on;

    # Don't serve gzip responses to clients that canâ€™t handle them.
    gzip_vary on;

    # Enable gzip for proxied requests.
    gzip_proxied any;

    # Balance compression vs CPU utilization.
    gzip_comp_level 5;

    # gzip_buffers 16 8k;

    # Prevent issues with HTTP/1.0 clients.
    gzip_http_version 1.1;

    # Specific mime types to gzip
    # Apparently 'text/html' is default - need not be specified.
    gzip_types
        text/plain
        text/css
        text/xml
        application/javascript
        application/json
        application/xml
        image/svg+xml;

    server {
        listen          4200;
        server_name     _;

        root            /app/ui;
        index           index.html;

        #
        # Angular application
        #
        location / {
            # Recommended pattern for Angular applications
            try_files   $uri $uri/ /index.html;


            # Don't cache index.html
            location = /index.html {
                add_header Cache-Control "no-cache, must-revalidate";
            }

            # Cache fingerprinted JS/CSS for 30 days.
            # These files have hashes in their names (immutable)
            location ~* \.(?:js|css)$ {
                add_header Cache-Control "public, max-age=2592000, immutable";
            }

            # Cache other static assets for 7 days.
            location ~* \.(?:svg|ico|json|woff2?|eot|ttf)$ {
                add_header Cache-Control "public, max-age=604800";
            }
        }

        #
        # WebSocket to receive OTLP logs
        #
        location /view/ws/ {
            proxy_pass http://0.0.0.0:8000;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
